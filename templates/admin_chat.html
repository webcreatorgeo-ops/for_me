<!DOCTYPE html>
<html lang="ka">
<head>
  {% include 'base.html' %}

  <meta charset="UTF-8">
  <title>ადმინის ჩატი</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <style>
   body {
  background: linear-gradient(to right, #eef2f3, #8e9eab);
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}

.navbar {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  z-index: 9999;
  box-shadow: 0 2px 5px rgba(0,0,0,0.2);
}

.chat-container {
  max-width: 600px;
  margin: 25px auto 0 auto; /* ზევიდან 25px */
  display: flex;
  flex-direction: column;
}

#chat-box {
  border-radius: 15px;
  border: 2px solid #ccc;
  height: 400px;
  overflow-y: auto;
  padding: 15px;
  margin-top: 50px; /* ნავბარისა და ჩატის შორის დაშორება */
  margin-bottom: 10px;
  background: #f9f9f9;
  box-shadow: 0 4px 8px rgba(0,0,0,0.1);
  display: flex;
  flex-direction: column;
  gap: 8px;
}


.msg-user, .msg-admin {
  display: flex;
  flex-direction: column;
  padding: 8px 12px;
  border-radius: 15px;
  word-wrap: break-word;
  max-width: 75%;
}

.msg-user {
  background: #d4edda;
  color: #155724;
  align-self: flex-start;
}

.msg-admin {
  background: #cce5ff;
  color: #004085;
  align-self: flex-end;
}

h3 {
  text-align: center;
  color: #343a40;
  margin-bottom: 0px;
}

.input-group {
  border-radius: 20px;
  overflow: hidden;
  box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}

.form-control {
  border: none;
  border-radius: 0;
  padding: 10px 15px;
}

.btn-success {
  background: linear-gradient(45deg, #28a745, #218838);
  border: none;
  border-radius: 0;
  font-weight: bold;
}

.btn-success:hover {
  background: linear-gradient(45deg, #218838, #28a745);
}

  </style>
</head>
<body class="p-5">

<h3>ჩატი მომხმარებელთან</h3>
<div id="chat-box"></div>

<form id="chat-form">
  <div class="input-group">
    <input type="text" id="message" class="form-control" placeholder="პასუხის მიწერა..." required>
    <button class="btn btn-success" type="submit">გაგზავნა</button>
  </div>
</form>
<script>
 let userId = {{ user.id }};
let lastMessageId = 0;

function loadMessages() {
  $.getJSON(`/get_messages/${userId}`, function(data) {
    let box = $("#chat-box");
    let newMessageAdded = false;

    data.forEach(m => {
      if (m.id > lastMessageId) {
        let cls = m.sender === "user" ? "msg-user" : "msg-admin";
        box.append(`<div class="${cls}"><b>${m.sender === 'user' ? '👤' : '🛡️'}:</b> ${m.message} <small>${m.time}</small></div>`);
        lastMessageId = m.id;
        newMessageAdded = true;
      }
    });

    // სკროლი მხოლოდ მაშინ, როცა ახალი მესიჯი ემატება
    if (newMessageAdded) {
      box.scrollTop(box[0].scrollHeight);
    }
  });
}

$("#chat-form").submit(function(e) {
  e.preventDefault();
  const msg = $("#message").val();
  if (!msg) return;

  $.post(`/admin/send/${userId}`, { message: msg }, function() {
    $("#message").val("");
    loadMessages();
  });
});

setInterval(loadMessages, 2000);
loadMessages();


</script>



</body>
</html>
